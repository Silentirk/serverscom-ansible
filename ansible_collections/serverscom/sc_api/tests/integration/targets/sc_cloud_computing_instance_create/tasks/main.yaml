---
- name: Check if there are sc_token and sc_endpoint variables
  no_log: true
  fail:
    msg: 'You need to define sc_token and sc_endpoint variables in tests/integration/integration_config.yml'
  when: not sc_endpoint or not sc_token

- name: Test1 invalid token
  sc_cloud_computing_instance_create:
    token: invalid
    endpoint: '{{ sc_endpoint }}'
    region_id: 0
    image_id: 'no-no-no'
    name: 'no-no-no'
  register: test1
  failed_when:
    - test1 is success
    - sc_endpoint not in test1.api_url
    - test1.status_code != 401

- name: Test2, Install for invalid region
  sc_cloud_computing_instance_create:
    token: '{{ sc_token }}'
    endpoint: '{{ sc_endpoint }}'
    region_id: 42424242
    image_id: 'no-no-no'
    name: 'no-no-no'
  register: test2
  failed_when: false

- name: Check Test2
  assert:
    that:
      - test2 is not changed
      - test2.status_code > 400
      - "'v1/cloud_computing/regions/424242/instance' in test2.api_url"

- name: Get image id
  sc_cloud_computing_images_info:
    token: '{{ sc_token }}'
    endpoint: '{{ sc_endpoint }}'
    region: 0
  register: img_info

- name: Get flavor id
  sc_cloud_computing_flavors_info:
    token: '{{ sc_token }}'
    endpoint: '{{ sc_endpoint }}'
    region: 0
  register: flavor_info

- name: Test3, create instance
  sc_cloud_computing_instance_create:
    token: '{{ sc_token }}'
    endpoint: '{{ sc_endpoint }}'
    region_id: 0
    flavor_id: '{{ flavor_info.cloud_flavors[0].id }}'
    image_id: '{{ img_info.cloud_images[0].id }}'
  register: test3
  failed_when: false

- debug: var=test3

- name: Check Test3
  assert:
    that:
      - test3 is changed

- fail:
- name: Test3, Reinstall existing instance no image
  sc_cloud_computing_instance_create:
    token: '{{ sc_token }}'
    endpoint: '{{ sc_endpoint }}'
    instance_id: 'pjqZRnM5'
  register: test3

- name: Check Test3
  assert:
    that:
      - test3 is changed
      - test3.name == 'rebuildme'
